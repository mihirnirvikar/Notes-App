<!-- edit-note.ejs -->
<form action="/notes/<%= note._id %>?_method=PUT" method="POST" onsubmit="submitNote()">
  <input type="text" name="title" value="<%= note.title %>" required><br><br>

  <!-- Toolbar -->
  <div id="toolbar">
    <span class="ql-formats">
      <select class="ql-header">
        <option selected></option>
        <option value="1"></option>
        <option value="2"></option>
      </select>
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-underline"></button>
    </span>

    <span class="ql-formats">
      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>
    </span>

    <span class="ql-formats">
      <button class="ql-link"></button>
      <button class="ql-image"></button> <!-- Image button -->
    </span>
  </div>
  <div id="editor" style="height: 200px;"></div>

  <input type="hidden" name="description" id="hiddenDescription">

  <select name="priority">
    <option value="High" <%=note.priority==='High' ? 'selected' : '' %>>High</option>
    <option value="Medium" <%=note.priority==='Medium' ? 'selected' : '' %>>Medium</option>
    <option value="Low" <%=note.priority==='Low' ? 'selected' : '' %>>Low</option>
  </select><br><br>

  <input type="date" name="dueDate" value="<%= note.dueDate ? note.dueDate.toISOString().split('T')[0] : '' %>"><br><br>

  <button type="submit">Update Note</button>
</form>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
  // Initialize Quill with full toolbar and custom image handler
  var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: {
        container: '#toolbar',
        handlers: {
          image: imageHandler
        }
      }
    }
  });

  // Set editor content on page load
  quill.root.innerHTML = `<%- note.description %>`;

  function submitNote() {
    document.getElementById('hiddenDescription').value = quill.root.innerHTML;
  }

  function imageHandler() {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();

    input.onchange = async () => {
      const file = input.files[0];
      const formData = new FormData();
      formData.append('image', file);

      try {
        const res = await fetch('/upload-image', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        const range = quill.getSelection();
        quill.insertEmbed(range.index, 'image', data.imageUrl);
      } catch (err) {
        console.error('Image upload failed', err);
      }
    };
  }
</script>
